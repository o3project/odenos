#!/bin/sh

###
MYNAME="${0##*/}"
#BUILD_OPTS="-DskipTests"
BUILD_OPTS="-Dmaven.test.skip"
FORMAT="\n%{url_effective}, %{response_code}\n"
ADDRESS=127.0.0.1
BUILD="${BUILD:-OFF}"


###
run()
{
	local res
	echo "--- $( date "+%Y-%m-%d %H:%M:%S" ): $* ---" | \
	  sed -n -e '1h ; 2,$H ; x ; s/\n/\\n/g ; h ; $p' >&2
	"$@"
	res=$?
	echo "--- res=$?" >&2
	return ${res}
}

restart_system()
{
	local res

	case "${BUILD}" in
	ON|on)
		res=0
		if ./odenos status | grep "is running" > /dev/null
		then
			./odenos stop
			sleep 1
		fi
		( mvn ${BUILD_OPTS} install ) || res=$?
		if [ ${res} -ne 0 ] ;then
			return ${res}
		fi
		( cd ./apps/java/sample_components && mvn ${BUILD_OPTS} package ) || res=$?
		if [ ${res} -ne 0 ] ;then
			return ${res}
		fi
		sleep 1
		;;
	esac

	if ./odenos status | grep "is not running" > /dev/null
	then
		./odenos start
		echo "--------------------------------" >&2
		echo "" >&2
	fi
	return 0
}

###
case "$1" in
-b)
	BUILD="ON"
	shift
	;;
esac

restart_system
res=$?
if [ ${res} -ne 0 ] ;then
	exit 1
fi

# create Network Component and DummyDriver1 Component
run curl http://$ADDRESS:10080/systemmanager/component_managers | python -mjson.tool
run curl -w "$FORMAT" http://$ADDRESS:10080/systemmanager/components/network1 -X PUT -d '{"type": "Network", "id": "network1", "cm_id": "romgr1"}'
run curl -w "$FORMAT" http://$ADDRESS:10080/systemmanager/components/driver1 -X PUT -d '{"type": "DummyDriver1", "id": "driver1", "cm_id": "romgr1"}'
run curl http://$ADDRESS:10080/systemmanager/components | python -mjson.tool

# connect Components
run curl -w "$FORMAT" http://$ADDRESS:10080/systemmanager/connections/conn1 -X PUT -d '{"id": "conn1", "type": "LogicAndNetwork", "connection_type": "original", "logic_id": "driver1", "network_id": "network1"}'
run curl http://$ADDRESS:10080/systemmanager/connections | python -mjson.tool
sleep 1

# create Topology
# --- (0)node01(1) ---- (2)node02(0) ---
#         (2)               (1)
#          |                 |
#          |                (2)
#          +----------- (1)node03(0) ---
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node01 -X PUT -d '{"node_id": "node01", "type": "Node", "ports": {}, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node02 -X PUT -d '{"node_id": "node02", "type": "Node", "ports": {}, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node03 -X PUT -d '{"node_id": "node03", "type": "Node", "ports": {}, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node01/ports/port010 -X PUT -d '{"type": "Port", "node_id": "node01", "port_id": "port010", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node01/ports/port011 -X PUT -d '{"type": "Port", "node_id": "node01", "port_id": "port011", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node01/ports/port012 -X PUT -d '{"type": "Port", "node_id": "node01", "port_id": "port012", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node02/ports/port020 -X PUT -d '{"type": "Port", "node_id": "node02", "port_id": "port020", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node02/ports/port021 -X PUT -d '{"type": "Port", "node_id": "node02", "port_id": "port021", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node02/ports/port022 -X PUT -d '{"type": "Port", "node_id": "node02", "port_id": "port022", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node03/ports/port030 -X PUT -d '{"type": "Port", "node_id": "node03", "port_id": "port030", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node03/ports/port031 -X PUT -d '{"type": "Port", "node_id": "node03", "port_id": "port031", "out_link": null, "in_link": null, "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/nodes/node03/ports/port032 -X PUT -d '{"type": "Port", "node_id": "node03", "port_id": "port032", "out_link": null, "in_link": null, "attributes": {}}'
#run curl http://$ADDRESS:10080/network1/topology/nodes -X GET | python -mjson.tool

run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/links/link012 -X PUT -d '{"type": "Link", "link_id": "link012", "src_node": "node01", "src_port": "port011", "dst_node": "node02", "dst_port": "port022", "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/links/link021 -X PUT -d '{"type": "Link", "link_id": "link021", "src_node": "node02", "src_port": "port022", "dst_node": "node01", "dst_port": "port011", "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/links/link023 -X PUT -d '{"type": "Link", "link_id": "link023", "src_node": "node02", "src_port": "port021", "dst_node": "node03", "dst_port": "port032", "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/links/link032 -X PUT -d '{"type": "Link", "link_id": "link032", "src_node": "node03", "src_port": "port032", "dst_node": "node02", "dst_port": "port021", "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/links/link031 -X PUT -d '{"type": "Link", "link_id": "link031", "src_node": "node03", "src_port": "port031", "dst_node": "node01", "dst_port": "port012", "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/topology/links/link013 -X PUT -d '{"type": "Link", "link_id": "link013", "src_node": "node01", "src_port": "port012", "dst_node": "node03", "dst_port": "port031", "attributes": {}}'
#run curl http://$ADDRESS:10080/network1/topology/links -X GET | python -mjson.tool

sleep 1
#run curl http://$ADDRESS:10080/network1/topology -X GET | python -mjson.tool

if ps -ef | grep "[n]eo4j" > /dev/null
then
	PYTHONPATH=lib/python apps/neo4j/neo4jsync.py topology
fi

# set Flows
run curl http://$ADDRESS:10080/network1/flows -X GET | python -mjson.tool

# Send and Receive Packets
echo "------ OutPacket  -------"
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out -X POST -d '{"type": "OutPacket", "node": "node01", "ports":["port010"] , "header":{"type": "BasicFlowMatch", "in_node": "node01", "in_port": "port010"}, "data": "ABCDEFGHIJKLM", "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out -X GET
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out/0000000000 -X GET
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out/0000000000 -X GET
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out -X POST -d '{"type": "OutPacket", "node": "node01", "ports":["port010"] , "header":{"type": "BasicFlowMatch", "in_node": "node01", "in_port": "port010"}, "data": "NOPQRSTUBWXYZ", "attributes": {}}'
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out -X GET
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out/0000000001 -X GET
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out/0000000001 -X GET
# deleted on DummyDriver1
#run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out/0000000000 -X DELETE
# status codes are 404 for following two requests
sleep 1
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out/0000000000 -X GET
run curl -w "$FORMAT" http://$ADDRESS:10080/network1/packets/out/0000000001 -X GET

# delete network
sleep 1
run curl -w "$FORMAT" http://$ADDRESS:10080/systemmanager/connections/conn1 -X DELETE
sleep 1
run curl -w "$FORMAT" http://$ADDRESS:10080/systemmanager/components/driver1 -X DELETE
run curl -w "$FORMAT" http://$ADDRESS:10080/systemmanager/components/network1 -X DELETE

# EOF
